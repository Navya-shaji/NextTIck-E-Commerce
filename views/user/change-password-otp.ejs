<%- include("../../views/partials/user/header.ejs") %>

    <head>
        <link rel="stylesheet" href="/styles/profile.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>

    <main class="main">
        <div class="breadcrumb-wrap">
            <div class="profile-container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/userProfile">My Account</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Verification</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="profile-container">
            <div class="premium-form-card">
                <h4 class="card-title">Security Check</h4>
                <p class="text-muted mb-4">Please enter the 6-digit OTP sent to your registered email to continue.</p>

                <form id="otpForm">
                    <div class="form-group">
                        <label for="otp" class="info-label">Enter OTP</label>
                        <input type="text" id="otp" name="otp" class="form-control text-center" maxlength="6"
                            style="font-size: 2rem; letter-spacing: 10px; font-family: var(--font-body);" required>
                        <small id="otpError" class="text-danger"></small>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn-gold" id="verifyBtn">Verify OTP</button>
                    </div>

                    <div id="alertMessage" class="alert alert-danger mt-4 text-center" style="display: none;"></div>
                </form>

                <div class="mt-4 pt-3 border-top">
                    <p class="text-muted">Didn't receive the code? <a href="#" id="resendOtp" class="link-gold">Resend
                            OTP</a></p>
                </div>
            </div>
        </div>
    </main>

    <%- include("../../views/partials/user/footer.ejs") %>

        <script>
            document.getElementById('otpForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const otp = document.getElementById('otp').value;
                const verifyBtn = document.getElementById('verifyBtn');
                const alertMsg = document.getElementById('alertMessage');

                verifyBtn.disabled = true;
                verifyBtn.innerHTML = 'Verifying...';
                alertMsg.style.display = 'none';

                fetch('/verify-changepassword-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ otp: otp }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Security check passed!',
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.href = data.redirectUrl;
                            });
                        } else {
                            alertMsg.textContent = data.message;
                            alertMsg.style.display = 'block';
                            verifyBtn.disabled = false;
                            verifyBtn.innerHTML = 'Verify OTP';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alertMsg.textContent = 'An error occurred. Please try again.';
                        alertMsg.style.display = 'block';
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = 'Verify OTP';
                    });
            });

            document.getElementById('resendOtp').addEventListener('click', function (e) {
                e.preventDefault();
                fetch('/resend-forgot-otp', {
                    method: 'POST',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Resent',
                                text: 'OTP has been sent to your email.',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire('Error', 'Failed to resend OTP', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Connection failed', 'error');
                    });
            });
        </script>