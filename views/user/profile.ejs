<%- include("../../views/partials/user/header.ejs") %>

  <head>
    <link rel="stylesheet" href="/styles/profile.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  </head>

  <main class="main">
    <div class="breadcrumb-wrap">
      <div class="container">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">My Account</li>
          </ol>
        </nav>
      </div>
    </div>

    <div class="profile-container">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
          <div class="profile-sidebar">
            <div class="user-avatar-section">
              <div class="avatar-wrapper">
                <% const defaultAvatar="https://cdn-icons-png.flaticon.com/512/4128/4128176.png" ; const
                  avatarUrl=user.profileImage && user.profileImage !=='default-profile.jpg' ?
                  `/uploads/profile-images/${user.profileImage}` : defaultAvatar; %>
                  <img src="<%= avatarUrl %>" alt="User Avatar" class="avatar-image" id="profileImage"
                    onerror="this.src='<%= defaultAvatar %>'">

                  <div class="avatar-actions">
                    <form id="profileImageForm" enctype="multipart/form-data">
                      <label for="profileImageInput" class="avatar-btn" title="Update Image">
                        <i class="fas fa-camera"></i>
                      </label>
                      <input type="file" id="profileImageInput" name="profileImage" accept="image/*"
                        style="display: none;">
                    </form>
                    <% if (user.profileImage && user.profileImage !=='default-profile.jpg' && user.profileImage
                      !==defaultAvatar) { %>
                      <button onclick="deleteProfileImage()" class="avatar-btn" title="Delete Image">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                      <% } %>
                  </div>
              </div>
              <h4 class="user-name">
                <%= user.name %>
              </h4>
              <p class="user-email">
                <%= user.email %>
              </p>
            </div>

            <div class="profile-nav nav flex-column nav-pills" id="v-pills-tab" role="tablist"
              aria-orientation="vertical">
              <a class="profile-nav-link active" id="v-pills-profile-tab" data-bs-toggle="pill" href="#v-pills-profile"
                role="tab">
                <i class="fas fa-user-circle"></i> Profile Overview
              </a>
              <a class="profile-nav-link" id="v-pills-orders-tab" data-bs-toggle="pill" href="#v-pills-orders"
                role="tab">
                <i class="fas fa-box"></i> My Orders
              </a>
              <a class="profile-nav-link" id="v-pills-address-tab" data-bs-toggle="pill" href="#v-pills-address"
                role="tab">
                <i class="fas fa-map-marker-alt"></i> Addresses
              </a>
              <a class="profile-nav-link" id="v-pills-wallet-tab" data-bs-toggle="pill" href="#v-pills-wallet"
                role="tab">
                <i class="fas fa-wallet"></i> My Wallet
              </a>
              <a class="profile-nav-link logout" href="/logout">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </div>
          </div>
        </div>

        <!-- Content Area -->
        <div class="col-lg-9">
          <div class="profile-content-card">
            <div class="tab-content" id="v-pills-tabContent">

              <!-- Profile Tab -->
              <div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel">
                <div class="section-title">
                  <span>Profile Information</span>
                  <button class="btn-gold" id="saveButton" onclick="saveProfileChanges()" disabled>Save Changes</button>
                </div>
                <div class="info-grid">
                  <div class="info-item">
                    <div class="info-label">Full Name</div>
                    <div class="info-value">
                      <input type="text" class="form-control-plaintext" id="editName" value="<%= user.name %>" disabled>
                      <button class="edit-trigger" onclick="toggleEdit('editName')"><i class="fas fa-edit"></i></button>
                    </div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Email Address</div>
                    <div class="info-value">
                      <span>
                        <%= user.email %>
                      </span>
                      <small class="text-muted">Primary</small>
                    </div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Phone Number</div>
                    <div class="info-value">
                      <input type="tel" class="form-control-plaintext" id="editPhone" value="<%= user.phone || '' %>"
                        disabled placeholder="Add phone">
                      <button class="edit-trigger" onclick="toggleEdit('editPhone')"><i
                          class="fas fa-edit"></i></button>
                    </div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Security</div>
                    <div class="info-value">
                      <span>••••••••</span>
                      <button class="edit-trigger" onclick="showChangePasswordModal()">Change</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Orders Tab -->
              <div class="tab-pane fade" id="v-pills-orders" role="tabpanel">
                <div class="section-title">Your Orders</div>
                <div class="table-responsive">
                  <table class="premium-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Total</th>
                        <th>Payment</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                      <% if (typeof orders !=='undefined' && orders.length> 0) { %>
                        <% orders.forEach(order=> { %>
                          <tr>
                            <td>#<%= order.orderId %>
                            </td>
                            <td>
                              <%= new Date(order.createdOn).toLocaleDateString() %>
                            </td>
                            <td>
                              <span class="badge-premium <%= 
                                  order.status.toLowerCase() === 'pending' ? 'badge-pending' : 
                                  order.status.toLowerCase() === 'delivered' ? 'badge-success' : 
                                  'badge-danger' %>">
                                <%= order.status %>
                              </span>
                            </td>
                            <td class="fw-bold">₹<%= (order.finalAmount || 0).toFixed(2) %>
                            </td>
                            <td>
                              <span
                                class="<%= order.paymentStatus.toLowerCase() === 'paid' ? 'text-success' : 'text-warning' %>">
                                <%= order.paymentStatus %>
                              </span>
                            </td>
                            <td>
                              <div class="dropdown">
                                <button class="btn-outline-gold dropdown-toggle px-3 py-2" type="button"
                                  id="orderAction<%= order._id %>" data-bs-toggle="dropdown" aria-expanded="false"
                                  style="font-size: 0.8rem;">
                                  Action
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0"
                                  aria-labelledby="orderAction<%= order._id %>">
                                  <li>
                                    <a class="dropdown-item py-2" href="/orders/view/<%= order._id %>">
                                      <i class="fas fa-eye me-2 text-primary"></i> View Details
                                    </a>
                                  </li>

                                  <% if (order.status==='Pending' ) { %>
                                    <li>
                                      <button class="dropdown-item py-2 text-danger"
                                        onclick="cancelOrder('<%= order._id %>')">
                                        <i class="fas fa-times me-2"></i> Cancel Order
                                      </button>
                                    </li>
                                    <% } %>

                                      <% if (order.paymentStatus==='Pending' && order.status !=='Cancelled' ) { %>
                                        <li>
                                          <button class="dropdown-item py-2 text-success"
                                            onclick="retryPayment('<%= order._id %>')">
                                            <i class="fas fa-redo me-2"></i> Retry Payment
                                          </button>
                                        </li>
                                        <% } %>

                                          <% if (order.status==='Delivered' && !order.returnedByUser) { %>
                                            <li>
                                              <a class="dropdown-item py-2 text-warning"
                                                href="/return-reason/<%= order._id %>">
                                                <i class="fas fa-undo me-2"></i> Return Order
                                              </a>
                                            </li>
                                            <% } %>
                                </ul>
                              </div>
                            </td>
                          </tr>
                          <% }); %>
                            <% } else { %>
                              <tr>
                                <td colspan="6" class="text-center py-5">
                                  <div class="text-muted">
                                    <i class="fas fa-shopping-bag fa-3x mb-3"></i>
                                    <p>No orders yet.</p>
                                    <a href="/shop" class="btn-gold mt-3">Start Shopping</a>
                                  </div>
                                </td>
                              </tr>
                              <% } %>
                    </tbody>
                  </table>

                  <!-- Pagination -->
                  <% if (typeof pagination !=='undefined' && pagination.totalPages> 1) { %>
                    <nav aria-label="Orders pagination" class="mt-4">
                      <ul class="pagination justify-content-center">
                        <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
                          <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&tab=v-pills-orders-tab"
                            aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                        <% for(let i=1; i <=pagination.totalPages; i++) { %>
                          <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= i %>&tab=v-pills-orders-tab">
                              <%= i %>
                            </a>
                          </li>
                          <% } %>
                            <li
                              class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
                              <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&tab=v-pills-orders-tab"
                                aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                              </a>
                            </li>
                      </ul>
                    </nav>
                    <% } %>
                </div>
              </div>

              <!-- Address Tab -->
              <div class="tab-pane fade" id="v-pills-address" role="tabpanel">
                <div class="section-title">
                  <span>Saved Addresses</span>
                  <a href="/add-address" class="btn-gold">Add New</a>
                </div>
                <div class="row">
                  <% if (userAddress && userAddress.address && userAddress.address.length> 0) { %>
                    <% userAddress.address.forEach((addr)=> { %>
                      <div class="col-md-6 mb-4">
                        <div class="info-item h-100">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="mb-0 user-name" style="font-size: 1.1rem;">
                              <%= addr.name %>
                            </h5>
                            <div class="d-flex gap-2">
                              <a href="/edit-address/<%= addr.id %>" class="text-primary"><i
                                  class="fas fa-edit"></i></a>
                              <a href="/delete-address/<%= addr.id %>" class="text-danger"><i
                                  class="fas fa-trash-alt"></i></a>
                            </div>
                          </div>

                          <p class="mb-2 fw-bold text-dark"><i class="fas fa-map-pin me-2 text-warning"></i>
                            <%= addr.addressType %>
                          </p>
                          <p class="text-muted mb-1">
                            <%= addr.city %>, <%= addr.state %>
                          </p>
                          <p class="text-muted mb-1">
                            <%= addr.landMark %>
                          </p>
                          <p class="text-muted mb-1">PIN: <%= addr.pincode %>
                          </p>
                          <p class="text-muted mb-0">Phone: <strong>
                              <%= addr.phone %>
                            </strong></p>
                        </div>
                      </div>
                      <% }) %>
                        <% } else { %>
                          <div class="col-12 text-center py-5">
                            <p class="text-muted">No addresses saved.</p>
                          </div>
                          <% } %>
                </div>

                <!-- Address Pagination -->
                <% if (typeof pagination !=='undefined' && pagination.totalAddressPages> 1) { %>
                  <nav aria-label="Address pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                      <li class="page-item <%= pagination.currentAddressPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link"
                          href="?addressPage=<%= pagination.currentAddressPage - 1 %>&tab=v-pills-address-tab"
                          aria-label="Previous">
                          <span aria-hidden="true">&laquo;</span>
                        </a>
                      </li>
                      <% for(let i=1; i <=pagination.totalAddressPages; i++) { %>
                        <li class="page-item <%= pagination.currentAddressPage === i ? 'active' : '' %>">
                          <a class="page-link" href="?addressPage=<%= i %>&tab=v-pills-address-tab">
                            <%= i %>
                          </a>
                        </li>
                        <% } %>
                          <li
                            class="page-item <%= pagination.currentAddressPage === pagination.totalAddressPages ? 'disabled' : '' %>">
                            <a class="page-link"
                              href="?addressPage=<%= pagination.currentAddressPage + 1 %>&tab=v-pills-address-tab"
                              aria-label="Next">
                              <span aria-hidden="true">&raquo;</span>
                            </a>
                          </li>
                    </ul>
                  </nav>
                  <% } %>
              </div>

              <!-- Wallet Tab -->
              <div class="tab-pane fade" id="v-pills-wallet" role="tabpanel">
                <div class="section-title">Wallet Overview</div>
                <div class="wallet-premium-card">
                  <div class="wallet-label">Available Balance</div>
                  <h1 class="wallet-amount">₹<%= (wallet.totalBalance || 0).toFixed(2) %>
                  </h1>
                </div>

                <h5 class="mb-3" style="font-family: var(--font-heading); color: var(--primary-color);">Recent
                  Transactions</h5>
                <div class="table-responsive">
                  <table class="premium-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody id="walletTableBody">
                      <% if (wallet && wallet.transactions && wallet.transactions.length> 0) { %>
                        <% wallet.transactions.forEach(tx=> { %>
                          <tr>
                            <td>
                              <%= new Date(tx.date).toLocaleDateString() %>
                            </td>
                            <td class="text-muted">
                              <%= tx.description || 'Wallet Tx' %>
                            </td>
                            <td>
                              <span
                                class="badge-premium <%= tx.type === 'Withdrawal' || tx.type === 'Purchase' ? 'badge-danger' : 'badge-success' %>">
                                <%= tx.type %>
                              </span>
                            </td>
                            <td
                              class="fw-bold <%= tx.type === 'Withdrawal' || tx.type === 'Purchase' ? 'text-danger' : 'text-success' %>">
                              <%= tx.type==='Withdrawal' || tx.type==='Purchase' ? '-' : '+' %>₹<%= tx.amount %>
                            </td>
                          </tr>
                          <% }) %>
                            <% } else { %>
                              <tr>
                                <td colspan="4" class="text-center py-4 text-muted">No transactions found.</td>
                              </tr>
                              <% } %>
                    </tbody>
                  </table>

                  <!-- Wallet Pagination -->
                  <% if (typeof pagination !=='undefined' && pagination.totalWalletPages> 1) { %>
                    <nav aria-label="Wallet pagination" class="mt-4">
                      <ul class="pagination justify-content-center">
                        <li class="page-item <%= pagination.currentWalletPage === 1 ? 'disabled' : '' %>">
                          <a class="page-link"
                            href="?walletPage=<%= pagination.currentWalletPage - 1 %>&tab=v-pills-wallet-tab"
                            aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                        <% for(let i=1; i <=pagination.totalWalletPages; i++) { %>
                          <li class="page-item <%= pagination.currentWalletPage === i ? 'active' : '' %>">
                            <a class="page-link" href="?walletPage=<%= i %>&tab=v-pills-wallet-tab">
                              <%= i %>
                            </a>
                          </li>
                          <% } %>
                            <li
                              class="page-item <%= pagination.currentWalletPage === pagination.totalWalletPages ? 'disabled' : '' %>">
                              <a class="page-link"
                                href="?walletPage=<%= pagination.currentWalletPage + 1 %>&tab=v-pills-wallet-tab"
                                aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                              </a>
                            </li>
                      </ul>
                    </nav>
                    <% } %>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="mb-3">
              <label class="form-label small fw-bold">Current Password</label>
              <input type="password" class="form-control" id="currentPassword" required>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-bold">New Password</label>
              <input type="password" class="form-control" id="newPassword" required minlength="6">
            </div>
            <div class="mb-3">
              <label class="form-label small fw-bold">Confirm New Password</label>
              <input type="password" class="form-control" id="confirmPassword" required>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn-gold" onclick="changePassword()">Update Password</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <%- include("../../views/partials/user/footer.ejs") %>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      let hasChanges = false;

      function toggleEdit(inputId) {
        const input = document.getElementById(inputId);
        const saveButton = document.getElementById('saveButton');

        if (input.disabled) {
          input.disabled = false;
          input.classList.remove('form-control-plaintext');
          input.classList.add('form-control');
          input.focus();
          saveButton.disabled = false;
        } else {
          input.disabled = true;
          input.classList.add('form-control-plaintext');
          input.classList.remove('form-control');
          if (!hasChanges) saveButton.disabled = true;
        }
      }

      document.querySelectorAll('#editName, #editPhone').forEach(input => {
        input.addEventListener('input', () => {
          hasChanges = true;
          document.getElementById('saveButton').disabled = false;
        });
      });

      async function saveProfileChanges() {
        const name = document.getElementById('editName').value;
        const phone = document.getElementById('editPhone').value;

        if (!name.trim()) return Swal.fire('Error', 'Name is required', 'error');

        try {
          const response = await fetch('/update-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name.trim(), phone: phone.trim() })
          });
          const data = await response.json();
          if (data.success) {
            Swal.fire({ icon: 'success', title: 'Updated!', text: 'Profile changes saved.', timer: 1500, showConfirmButton: false });
            setTimeout(() => location.reload(), 1500);
          } else throw new Error(data.message);
        } catch (error) {
          Swal.fire('Error', error.message, 'error');
        }
      }

      // Avatar Logic
      document.getElementById('profileImageInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('profileImage', file);

        Swal.fire({ title: 'Uploading...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
          const res = await fetch('/update-profile-image', { method: 'POST', body: formData });
          const data = await res.json();
          if (data.success) {
            Swal.fire({ icon: 'success', title: 'Success', text: 'Image updated!', timer: 1000, showConfirmButton: false });
            setTimeout(() => location.reload(), 1000);
          } else throw new Error(data.message);
        } catch (err) {
          Swal.fire('Error', err.message, 'error');
        }
      });

      async function deleteProfileImage() {
        const res = await Swal.fire({ title: 'Delete image?', icon: 'warning', showCancelButton: true });
        if (res.isConfirmed) {
          try {
            const response = await fetch('/delete-profile-image', { method: 'POST' });
            const data = await response.json();
            if (data.success) location.reload();
            else throw new Error(data.message);
          } catch (err) { Swal.fire('Error', err.message, 'error'); }
        }
      }

      // Order Actions
      async function cancelOrder(orderId) {
        const res = await Swal.fire({ title: 'Cancel Order?', text: 'Are you sure you want to cancel?', icon: 'warning', showCancelButton: true });
        if (res.isConfirmed) {
          try {
            const response = await fetch('/orders/cancel', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId, status: "Cancelled" })
            });
            const data = await response.json();
            if (data.success) location.reload();
            else throw new Error(data.message);
          } catch (err) { Swal.fire('Error', err.message, 'error'); }
        }
      }

      async function retryPayment(orderId) {
        try {
          const response = await fetch('/orders/retry-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId })
          });
          const data = await response.json();
          if (!data.success) throw new Error(data.message);

          const options = {
            key: data.data.key_id,
            amount: data.data.amount,
            currency: data.data.currency,
            name: "NextTick",
            description: "Order Payment Retry",
            order_id: data.data.order_id,
            handler: function (response) {
              verifyRazorpayPayment(response, { orderId, userId: '<%= user._id %>' });
            },
            theme: { color: '#c5a059' }
          };
          new Razorpay(options).open();
        } catch (err) { Swal.fire('Error', err.message, 'error'); }
      }

      function verifyRazorpayPayment(response, details) {
        fetch('/verify-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...response, orderDetails: details, retryPayment: true, orderId: details.orderId })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) location.reload();
            else throw new Error(data.message);
          })
          .catch(err => Swal.fire('Error', err.message, 'error'));
      }

      // Password
      function showChangePasswordModal() {
        new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
      }

      async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) return Swal.fire('Error', 'Passwords mismatch', 'error');

        try {
          const response = await fetch('/change-password-direct', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ currentPassword, newPassword })
          });
          const data = await response.json();
          if (data.success) {
            Swal.fire('Success', 'Password updated!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
          } else throw new Error(data.message);
        } catch (err) { Swal.fire('Error', err.message, 'error'); }
      }

      // Handle tab persistence from URL
      document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTabId = urlParams.get('tab');
        if (activeTabId) {
          const tabEl = document.getElementById(activeTabId);
          if (tabEl) {
            const tab = new bootstrap.Tab(tabEl);
            tab.show();
          }
        }
      });

      // Make functions globally available
      window.toggleEdit = toggleEdit;
      window.saveProfileChanges = saveProfileChanges;
      window.deleteProfileImage = deleteProfileImage;
      window.cancelOrder = cancelOrder;
      window.retryPayment = retryPayment;
      window.showChangePasswordModal = showChangePasswordModal;
      window.changePassword = changePassword;
      window.verifyRazorpayPayment = verifyRazorpayPayment;

    </script>