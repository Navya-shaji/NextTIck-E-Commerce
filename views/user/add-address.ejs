<%- include("../../views/partials/user/header.ejs") %>

    <head>
        <link rel="stylesheet" href="/styles/profile.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>

    <main class="main">
        <div class="breadcrumb-wrap">
            <div class="profile-container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/userProfile">My Account</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Add Address</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="profile-container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="profile-content-card">
                        <div class="section-title">
                            <span>Add New Address</span>
                            <a href="/userProfile?tab=v-pills-address-tab" class="btn-outline-gold">Back to
                                Addresses</a>
                        </div>

                        <form id="addressForm" class="mt-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fullName" class="info-label">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" name="name"
                                        placeholder="Enter full name" required>
                                    <small class="text-danger" id="nameError"></small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="info-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone"
                                        placeholder="10-digit number" required>
                                    <small class="text-danger" id="phoneError"></small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="addressType" class="info-label">Address (House No, Building, Street)</label>
                                <textarea class="form-control" id="addressType" name="addressType" rows="3"
                                    placeholder="Enter your address details" required></textarea>
                                <small class="text-danger" id="addressError"></small>
                            </div>

                            <div class="mb-3">
                                <label for="city" class="info-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="City"
                                    required>
                                <small class="text-danger" id="cityError"></small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="state" class="info-label">State</label>
                                    <input type="text" class="form-control" id="state" name="state" placeholder="State"
                                        required>
                                    <small class="text-danger" id="stateError"></small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pincode" class="info-label">Pincode</label>
                                    <input type="text" class="form-control" id="pincode" name="pincode"
                                        placeholder="6-digit PIN" required>
                                    <small class="text-danger" id="pincodeError"></small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="landmark" class="info-label">Landmark</label>
                                <input type="text" class="form-control" id="landmark" name="landmark"
                                    placeholder="Nearby landmark" required>
                                <small class="text-danger" id="landmarkError"></small>
                            </div>

                            <div class="mb-3">
                                <label for="altPhone" class="info-label">Alternative Phone (Optional)</label>
                                <input type="tel" class="form-control" id="altPhone" name="altPhone"
                                    placeholder="Alternate number">
                                <small class="text-danger" id="altPhoneError"></small>
                            </div>

                            <div class="d-flex justify-content-end gap-3 mt-4">
                                <a href="/userProfile?tab=v-pills-address-tab" class="btn-outline-gold">Cancel</a>
                                <button type="submit" class="btn-gold" id="saveButton">Save Address</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <%- include("../../views/partials/user/footer.ejs") %>

        <script>
            document.getElementById('addressForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const fullName = document.getElementById('fullName').value;
                const phone = document.getElementById('phone').value;
                const addressType = document.getElementById('addressType').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const landmark = document.getElementById('landmark').value;
                const pincode = document.getElementById('pincode').value;
                const altPhone = document.getElementById('altPhone').value;
                const saveButton = document.getElementById('saveButton');

                document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

                let valid = true;
                const nameRegex = /^[A-Za-z\s]+$/;
                const phoneRegex = /^\d{10}$/;
                const pincodeRegex = /^\d{6}$/;

                if (!fullName.trim() || !nameRegex.test(fullName)) {
                    document.getElementById('nameError').textContent = "Name must contain only letters.";
                    valid = false;
                }
                if (!phoneRegex.test(phone)) {
                    document.getElementById('phoneError').textContent = "Phone must be 10 digits.";
                    valid = false;
                }
                if (!addressType.trim()) {
                    document.getElementById('addressError').textContent = "Address is required.";
                    valid = false;
                }
                if (!city.trim()) {
                    document.getElementById('cityError').textContent = "City is required.";
                    valid = false;
                }
                if (!state.trim()) {
                    document.getElementById('stateError').textContent = "State is required.";
                    valid = false;
                }
                if (!pincodeRegex.test(pincode)) {
                    document.getElementById('pincodeError').textContent = "Pincode must be 6 digits.";
                    valid = false;
                }
                if (!landmark.trim()) {
                    document.getElementById('landmarkError').textContent = "Landmark is required.";
                    valid = false;
                }
                if (altPhone && !phoneRegex.test(altPhone)) {
                    document.getElementById('altPhoneError').textContent = "Alt phone must be 10 digits.";
                    valid = false;
                }

                if (!valid) return;

                saveButton.disabled = true;
                saveButton.innerHTML = 'Saving...';

                try {
                    const response = await fetch('/addaddress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: fullName,
                            phone,
                            addressType,
                            city,
                            state,
                            landMark: landmark,
                            pincode,
                            altPhone
                        }),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Address Saved',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = '/userProfile?tab=v-pills-address-tab';
                        });
                    } else {
                        throw new Error(result.message || 'Failed to save address');
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message,
                    });
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save Address';
                }
            });
        </script>