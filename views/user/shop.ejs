<%- include("../../views/partials/user/header") %>

  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet">
    <style>
      :root {
        --primary-color: #1a1a1a;
        --secondary-color: #ffffff;
        --accent-color: #c5a059;
        --text-color: #2d2d2d;
        --light-text: #757575;
        --white: #ffffff;
        --font-heading: 'Cinzel', serif;
        --font-body: 'Outfit', sans-serif;
        --border-color: #eeeeee;
      }

      body {
        font-family: var(--font-body);
        color: var(--text-color);
        background-color: var(--secondary-color);
      }

      .shop-banner {
        background: #fff;
        padding: 80px 0 60px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
      }

      .shop-banner h1 {
        font-family: var(--font-heading);
        font-size: 3rem;
        letter-spacing: 6px;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .shop-banner p {
        font-size: 1rem;
        color: var(--light-text);
        font-weight: 300;
        letter-spacing: 1px;
      }

      .main-container {
        max-width: 1440px;
        margin: 0 auto;
        padding: 60px 40px;
        background: #ffffff;
      }

      .shop-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 60px;
      }

      /* Filters Styling */
      .filters-sidebar {
        background: #fff;
        padding: 0;
        position: sticky;
        top: 120px;
        height: fit-content;
      }

      .filter-section {
        margin-bottom: 40px;
      }

      .filter-section h3 {
        font-family: var(--font-heading);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 25px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }

      .filter-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .filter-item {
        margin-bottom: 12px;
      }

      .filter-link {
        text-decoration: none;
        color: var(--light-text);
        font-size: 0.95rem;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }

      .filter-link:hover,
      .filter-link.active {
        color: var(--accent-color);
        font-weight: 500;
      }

      .price-filter .inputs {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .price-filter input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        font-size: 0.85rem;
        outline: none;
      }

      .apply-btn {
        width: 100%;
        padding: 12px;
        background: var(--primary-color);
        color: #fff;
        border: none;
        font-family: var(--font-heading);
        font-size: 0.75rem;
        letter-spacing: 1px;
        margin-top: 15px;
        cursor: pointer;
        transition: 0.3s;
      }

      .apply-btn:hover {
        background: var(--accent-color);
        color: var(--primary-color);
      }

      .reset-link {
        display: block;
        margin-top: 20px;
        text-align: center;
        color: #ff4d4d;
        text-decoration: none;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Products Display */
      .products-area {
        flex: 1;
      }

      .shop-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .search-form-lite {
        display: flex;
        border: 1px solid var(--border-color);
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        transition: 0.3s;
      }

      .search-form-lite:focus-within {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
      }

      .search-form-lite input {
        padding: 12px 20px;
        border: none;
        width: 300px;
        outline: none;
        font-size: 0.9rem;
      }

      .search-form-lite button {
        background: transparent;
        border: none;
        padding: 0 15px;
        cursor: pointer;
        color: var(--light-text);
      }

      .sort-select-premium {
        padding: 12px 20px;
        border: 1px solid var(--border-color);
        background: #fff;
        font-family: var(--font-body);
        font-size: 0.9rem;
        cursor: pointer;
        outline: none;
      }

      .product-grid-premium {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
      }

      .product-card-premium {
        background: #fff;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 24px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .product-card-premium:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        border-color: transparent;
      }

      .image-wrapper {
        position: relative;
        padding-top: 110%;
        /* Slightly taller for more elegance */
        overflow: hidden;
        background: #fdfdfd;
      }

      .image-wrapper img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        /* Better for luxury products than cover */
        padding: 20px;
        transition: 1s cubic-bezier(0.165, 0.84, 0.44, 1);
      }

      .product-card-premium:hover .image-wrapper img {
        transform: scale(1.1) translateY(-5px);
      }

      /* Collapsible Sidebar Styles */
      .filter-header {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        user-select: none;
      }

      .filter-header h3 {
        margin: 0;
        font-family: var(--font-heading);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--primary-color);
      }

      .filter-header i {
        font-size: 0.7rem;
        transition: transform 0.3s;
      }

      .filter-header.collapsed i {
        transform: rotate(-90deg);
      }

      .filter-content {
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.4s ease, opacity 0.3s ease;
        opacity: 1;
        margin-bottom: 30px;
      }

      .filter-header.collapsed+.filter-content {
        max-height: 0;
        opacity: 0;
        margin-bottom: 0;
      }

      .badge-status {
        position: absolute;
        top: 15px;
        left: 15px;
        padding: 5px 12px;
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        z-index: 10;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .badge-new {
        background: var(--accent-color);
        color: var(--primary-color);
      }

      .badge-out {
        background: #ff4d4d;
        color: #fff;
      }

      .wishlist-pill {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 38px;
        height: 38px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        z-index: 10;
        transition: 0.3s;
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      .wishlist-pill:hover {
        background: #fff;
        transform: scale(1.1);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }

      .wishlist-pill i {
        font-size: 1.1rem;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .wishlist-pill:active i {
        transform: scale(0.8);
      }

      .item-details-premium {
        padding: 20px 24px 24px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .brand-label {
        font-size: 0.7rem;
        color: var(--accent-color);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 8px;
        font-weight: 700;
        opacity: 0.8;
      }

      .product-name-premium {
        font-family: var(--font-body);
        font-size: 1.1rem;
        color: var(--primary-color);
        text-decoration: none;
        margin-bottom: 12px;
        display: block;
        font-weight: 600;
        line-height: 1.4;
        height: 2.8em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-clamp: 2;
      }

      .price-display-premium {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .original-price {
        text-decoration: line-through;
        color: #b0b0b0;
        font-size: 0.9rem;
        font-weight: 400;
      }

      .action-btn-premium {
        width: 100%;
        padding: 14px;
        background: #f8f8f8;
        color: var(--primary-color);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        font-family: var(--font-body);
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-top: auto;
      }

      .product-card-premium:hover .action-btn-premium {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
      }

      .action-btn-premium:hover:not(:disabled) {
        background: var(--accent-color) !important;
        color: var(--primary-color) !important;
        transform: translateY(-2px);
      }

      .action-btn-premium:disabled {
        background: #fdfdfd;
        color: #ccc;
        border-color: #eee;
        cursor: not-allowed;
      }

      /* Pagination Premium */
      .pagination-premium {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 80px;
      }

      .page-link-premium {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-color);
        background: #fff;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        transition: 0.3s;
      }

      .page-link-premium.active,
      .page-link-premium:hover {
        background: var(--primary-color);
        color: var(--accent-color);
        border-color: var(--primary-color);
      }

      @media (max-width: 1024px) {
        .shop-grid {
          grid-template-columns: 1fr;
        }

        .filters-sidebar {
          position: static;
          margin-bottom: 40px;
        }

        .search-form-lite input {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="shop-banner">
      <div class="container">
        <h1>Timeless Elegance</h1>
        <p>Curating the world's most distinguished horological masterpieces.</p>
      </div>
    </div>

    <div class="main-container">
      <div class="shop-grid">
        <!-- Sidebar -->
        <aside class="filters-sidebar">
          <form id="masterFilterForm" action="/shop" method="GET">
            <!-- Keep search query if present -->
            <% if (query.query) { %>
              <input type="hidden" name="query" value="<%= query.query %>">
              <% } %>
                <% if (query.sort) { %>
                  <input type="hidden" name="sort" value="<%= query.sort %>">
                  <% } %>

                    <div class="filter-section">
                      <div class="filter-header" onclick="this.classList.toggle('collapsed')">
                        <h3>Categories</h3>
                        <i class="fas fa-chevron-down"></i>
                      </div>
                      <div class="filter-content">
                        <ul class="filter-list">
                          <li class="filter-item">
                            <label class="filter-link <%= !query.category ? 'active' : '' %>">
                              <input type="radio" name="category" value="" <%=!query.category ? 'checked' : '' %>
                              style="display: none;" onchange="this.form.submit()">
                              All Categories
                            </label>
                          </li>
                          <% categories.forEach(function(cat) { %>
                            <li class="filter-item">
                              <label class="filter-link <%= query.category === cat._id.toString() ? 'active' : '' %>">
                                <input type="radio" name="category" value="<%= cat._id %>"
                                  <%=query.category===cat._id.toString() ? 'checked' : '' %> style="display: none;"
                                onchange="this.form.submit()">
                                <%= cat.name %>
                              </label>
                            </li>
                            <% }); %>
                        </ul>
                      </div>
                    </div>

                    <div class="filter-section">
                      <div class="filter-header" onclick="this.classList.toggle('collapsed')">
                        <h3>Brands</h3>
                        <i class="fas fa-chevron-down"></i>
                      </div>
                      <div class="filter-content">
                        <ul class="filter-list">
                          <% brands.forEach(function(brand) { %>
                            <li class="filter-item">
                              <label class="filter-link <%= query.brand === brand._id.toString() ? 'active' : '' %>">
                                <input type="radio" name="brand" value="<%= brand._id %>"
                                  <%=query.brand===brand._id.toString() ? 'checked' : '' %> style="display: none;"
                                onchange="this.form.submit()">
                                <%= brand.brandName %>
                              </label>
                            </li>
                            <% }); %>
                        </ul>
                      </div>
                    </div>

                    <div class="filter-section price-filter">
                      <div class="filter-header" onclick="this.classList.toggle('collapsed')">
                        <h3>Price Range</h3>
                        <i class="fas fa-chevron-down"></i>
                      </div>
                      <div class="filter-content">
                        <div class="inputs">
                          <input type="number" name="minPrice" placeholder="Min" value="<%= query.minPrice || '' %>">
                          <input type="number" name="maxPrice" placeholder="Max" value="<%= query.maxPrice || '' %>">
                        </div>
                        <button type="submit" class="apply-btn">Apply Price</button>
                      </div>
                    </div>

                    <div class="filter-section">
                      <div class="filter-header" onclick="this.classList.toggle('collapsed')">
                        <h3>Availability</h3>
                        <i class="fas fa-chevron-down"></i>
                      </div>
                      <div class="filter-content">
                        <label class="filter-link">
                          <input type="checkbox" name="inStock" value="true" <%=query.inStock==='true' ? 'checked' : ''
                            %>
                          onchange="this.form.submit()">
                          Show In Stock Only
                        </label>
                      </div>
                    </div>

                    <a href="/shop" class="reset-link">Clear All</a>
          </form>
        </aside>

        <!-- Catalog Area -->
        <main class="products-area">
          <div class="shop-toolbar">
            <div class="search-form-lite">
              <form action="/shop" method="GET" style="display: flex;">
                <% if (query.category) { %><input type="hidden" name="category" value="<%= query.category %>">
                  <% } %>
                    <% if (query.brand) { %><input type="hidden" name="brand" value="<%= query.brand %>">
                      <% } %>
                        <input type="text" name="query" placeholder="Search our catalog..."
                          value="<%= query.query || '' %>">
                        <button type="submit"><i class="fas fa-search"></i></button>
              </form>
            </div>

            <select class="sort-select-premium"
              onchange="const u = new URL(window.location.href); u.searchParams.set('sort', this.value); window.location.href = u.toString()">
              <option value="price_asc" <%=query.sort==='price_asc' ? 'selected' : '' %>>Price: Low to High</option>
              <option value="price_desc" <%=query.sort==='price_desc' ? 'selected' : '' %>>Price: High to Low</option>
              <option value="a_to_z" <%=query.sort==='a_to_z' ? 'selected' : '' %>>A - Z</option>
              <option value="z_to_a" <%=query.sort==='z_to_a' ? 'selected' : '' %>>Z - A</option>
            </select>
          </div>

          <% if (products.length> 0) { %>
            <div class="product-grid-premium">
              <% products.forEach(function(product) { %>
                <div class="product-card-premium">
                  <div class="image-wrapper">
                    <% if (product.quantity <=0) { %>
                      <span class="badge-status badge-out">Sold Out</span>
                      <% } else if (new Date() - new Date(product.createdAt) < 14 * 24 * 60 * 60 * 1000) { %>
                        <span class="badge-status badge-new">New</span>
                        <% } %>

                          <div class="wishlist-pill" onclick="handleWishlistToggle('<%= product._id %>', this)">
                            <i
                              class="<%= wishlistItems.includes(product._id.toString()) ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
                          </div>

                          <a href="/productDetails?id=<%= product._id %>">
                            <img src="/uploads/re-image/<%= product.productImage[0] %>" alt="<%= product.productName %>"
                              onerror="this.src='/images/pexels-brett-sayles-1186851.jpg'">
                          </a>
                  </div>

                  <div class="item-details-premium">
                    <div class="brand-label">
                      <%= product.brand ? product.brand.brandName : 'Luxury' %>
                    </div>
                    <a href="/productDetails?id=<%= product._id %>" class="product-name-premium">
                      <%= product.productName %>
                    </a>

                    <div class="price-display-premium">
                      ₹<%= (product.salesPrice || product.regularPrice).toLocaleString('en-IN') %>
                        <% if (product.salesPrice && product.salesPrice < product.regularPrice) { %>
                          <span class="original-price">₹<%= product.regularPrice.toLocaleString('en-IN') %></span>
                          <% } %>
                    </div>

                    <button class="action-btn-premium" onclick="addToCart(event, '<%= product._id %>')"
                      <%=product.quantity> 0 ? '' : 'disabled' %>>
                      <%= product.quantity> 0 ? 'Add to Bag' : 'Out of Stock' %>
                    </button>
                  </div>
                </div>
                <% }); %>
            </div>

            <div class="pagination-premium">
              <% if (totalPages> 1) { %>
                <% if (currentPage> 1) { %>
                  <a href="<%= generatePageUrl(currentPage - 1) %>" class="page-link-premium"><i
                      class="fas fa-chevron-left"></i></a>
                  <% } %>

                    <% for(let i=1; i <=totalPages; i++) { %>
                      <a href="<%= generatePageUrl(i) %>"
                        class="page-link-premium <%= currentPage === i ? 'active' : '' %>">
                        <%= i %>
                      </a>
                      <% } %>

                        <% if (currentPage < totalPages) { %>
                          <a href="<%= generatePageUrl(currentPage + 1) %>" class="page-link-premium"><i
                              class="fas fa-chevron-right"></i></a>
                          <% } %>
                            <% } %>
            </div>
            <% } else { %>
              <div class="empty-state text-center py-5">
                <i class="fas fa-box-open fa-4x mb-4" style="color: #eee;"></i>
                <h2 class="cinzel">No Results Found</h2>
                <p class="text-muted">Revise your filters or search keywords.</p>
                <a href="/shop" class="apply-btn mt-4"
                  style="display: inline-block; width: auto; padding: 15px 40px;">View All Timepieces</a>
              </div>
              <% } %>
        </main>
      </div>
    </div>

    <% function generatePageUrl(page) { const p={ ...query }; p.page=page; return '/shop?' + new
      URLSearchParams(p).toString(); } %>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      <script>
        function addToCart(e, productId) {
          e.preventDefault();
          const b = e.target;
          b.disabled = true;
          b.innerText = 'PROCESSING...';

          fetch('/addToCart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId, quantity: 1 })
          })
            .then(r => r.json())
            .then(d => {
              if (d.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Item Added',
                  toast: true,
                  position: 'top-end',
                  showConfirmButton: false,
                  timer: 2000
                });
                $('.cart-count').text(d.cartCount);
              } else {
                Swal.fire('Note', d.message || 'Operation failed', 'info');
              }
            })
            .catch(() => Swal.fire('Error', 'Connection failed', 'error'))
            .finally(() => {
              b.disabled = false;
              b.innerText = 'ADD TO BAG';
            });
        }

        function handleWishlistToggle(productId, el) {
          if (!el) return;
          const i = el.querySelector('i');

          $.ajax({
            url: "/addToWishlist",
            method: "POST",
            data: { productId },
            success: function (r) {
              if (r.status) {
                const isAdded = r.action === 'added';
                i.className = isAdded ? 'fa-solid fa-heart' : 'fa-regular fa-heart';

                Swal.fire({
                  icon: 'success',
                  title: isAdded ? 'Saved' : 'Removed',
                  text: isAdded ? 'Added to your favorites' : 'Removed from favorites',
                  toast: true,
                  position: 'top-end',
                  showConfirmButton: false,
                  timer: 2000,
                  background: '#fff',
                  color: '#1a1a1a',
                  iconColor: isAdded ? '#ff4d4d' : '#ccc'
                });
              } else {
                Swal.fire({
                  icon: 'info',
                  title: 'Login Required',
                  text: 'Please sign in to manage your wishlist',
                  showCancelButton: true,
                  confirmButtonText: 'Sign In',
                  confirmButtonColor: '#1a1a1a'
                }).then(res => {
                  if (res.isConfirmed) window.location.href = '/login';
                });
              }
            },
            error: function (err) {
              console.error('Wishlist error:', err);
              if (err.status === 401) {
                window.location.href = '/login';
              }
            }
          });
        }
      </script>
  </body>

  <%- include("../../views/partials/user/footer.ejs") %>