<%- include("../../views/partials/admin/header") %>

    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
        <style>
            :root {
                --gold-primary: #a88732;
                --gold-secondary: #9c7a2c;
                --dark-bg: #0f172a;
                --slate-800: #1e293b;
            }

            body {
                background-color: #f8fafc;
                font-family: 'Outfit', sans-serif;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            body::-webkit-scrollbar {
                display: none;
            }

            * {
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }

            *::-webkit-scrollbar {
                display: none !important;
            }

            .content-wrapper {
                padding: 2.5rem;
                max-width: 1400px;
                margin: 0 auto;
            }

            .content-header {
                margin-bottom: 2rem;
            }

            .content-title {
                font-size: 2rem;
                font-weight: 800;
                color: var(--dark-bg);
                letter-spacing: -0.025em;
                margin-bottom: 0.5rem;
            }

            .content-subtitle {
                color: #64748b;
                font-size: 0.95rem;
            }

            .card {
                background: white;
                border-radius: 20px;
                border: 1px solid rgba(226, 232, 240, 0.8);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
                padding: 2rem;
                margin-bottom: 1.5rem;
            }

            .form-section-title {
                font-size: 1.1rem;
                font-weight: 700;
                color: #495057;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid var(--gold-primary);
                display: inline-block;
            }

            .form-label {
                font-weight: 600;
                font-size: 0.875rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #64748b;
                margin-bottom: 0.75rem;
            }

            .form-control,
            .form-select {
                border-radius: 12px;
                padding: 0.75rem 1rem;
                border: 1.5px solid #e2e8f0;
                transition: all 0.2s;
            }

            .form-control:focus,
            .form-select:focus {
                border-color: var(--gold-primary);
                box-shadow: 0 0 0 4px rgba(168, 135, 50, 0.1);
            }

            .error-message {
                display: none;
                color: #ef4444;
                font-size: 0.75rem;
                margin-top: 0.5rem;
                font-weight: 500;
            }

            .image-upload-container {
                border: 2px dashed #e2e8f0;
                border-radius: 12px;
                padding: 2rem 1rem;
                text-align: center;
                background-color: #f8fafc;
                transition: all 0.3s ease;
                cursor: pointer;
                position: relative;
            }

            .image-upload-container:hover {
                border-color: var(--gold-primary);
                background-color: #fdfaf3;
            }

            .image-upload-icon {
                font-size: 2.5rem;
                color: var(--gold-primary);
                margin-bottom: 1rem;
            }

            .image-upload-text {
                font-size: 0.95rem;
                color: #64748b;
                font-weight: 500;
            }

            #imageInput {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
            }

            .thumbnails-container {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                margin-top: 1rem;
            }

            .thumbnail-wrapper {
                position: relative;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                width: 120px;
                height: 120px;
            }

            .thumbnail {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .delete-btn {
                position: absolute;
                top: 8px;
                right: 8px;
                background: rgba(239, 68, 68, 0.95);
                color: white;
                border: none;
                border-radius: 50%;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .delete-btn:hover {
                background: #dc2626;
                transform: scale(1.1);
            }

            .btn-gold {
                background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
                color: white;
                border: none;
                border-radius: 12px;
                padding: 0.75rem 2rem;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-gold:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 15px rgba(168, 135, 50, 0.2);
                color: white;
            }

            .bordered-section {
                border-right: 1px solid #e9ecef;
                padding-right: 2rem;
            }

            @media (max-width: 768px) {
                .bordered-section {
                    border-right: none;
                    border-bottom: 1px solid #e9ecef;
                    padding-right: 0;
                    padding-bottom: 1.5rem;
                    margin-bottom: 1.5rem;
                }

                .content-wrapper {
                    padding: 1.5rem;
                }
            }

            .modal-content {
                border-radius: 16px;
                border: none;
            }

            .modal-header {
                border-bottom: 1px solid #e9ecef;
                padding: 1.5rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .modal-footer {
                border-top: 1px solid #e9ecef;
                padding: 1.5rem;
            }

            .img-container {
                max-height: 400px;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #f8f9fa;
                border-radius: 12px;
            }

            .img-container img {
                max-width: 100%;
                max-height: 400px;
                display: block;
            }
        </style>
    </head>

    <div class="content-wrapper">
        <div class="content-header">
            <h2 class="content-title">Add New Product</h2>
            <p class="content-subtitle">Create a new product listing with complete details</p>
        </div>
        <div class="col-lg-8">
            <form id="productAddForm" method="post" action="/admin/addProducts" enctype="multipart/form-data"
                onsubmit="return handleFormSubmit(event)">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 bordered-section">
                                <div class="form-section">
                                    <div class="form-section-title">Basic Information</div>
                                    <div class="mb-3">
                                        <label for="product_name" class="form-label">Product Name</label>
                                        <input type="text" placeholder="Enter product name" name="productName"
                                            class="form-control" id="product_name">
                                        <div id="productName-error" class="error-message"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="descriptionid" class="form-label">Description</label>
                                        <textarea class="form-control" id="descriptionid" name="description" rows="3"
                                            placeholder="Enter product description"></textarea>
                                        <div id="description-error" class="error-message"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-section">
                                    <div class="form-section-title">Product Details</div>
                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <label class="form-label">Brand</label>
                                            <select class="form-select" name="brand">
                                                <option value="">Select Brand</option>
                                                <% if (typeof brand !=='undefined' && brand.length> 0) { %>
                                                    <% for(let i=0; i < brand.length; i++) { %>
                                                        <option value="<%= brand[i]._id %>">
                                                            <%= brand[i].brandName %>
                                                        </option>
                                                        <% } %>
                                                            <% } %>
                                            </select>
                                            <div id="brand-error" class="error-message"></div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label class="form-label">Category</label>
                                            <select class="form-select" name="category">
                                                <option value="">Select Category</option>
                                                <% if (typeof cat !=='undefined' && cat.length> 0) { %>
                                                    <% for(let i=0; i < cat.length; i++) { %>
                                                        <option value="<%= cat[i].name %>">
                                                            <%= cat[i].name %>
                                                        </option>
                                                        <% } %>
                                                            <% } %>
                                            </select>
                                            <div id="category-error" class="error-message"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-4 mb-3">
                                            <label class="form-label">Regular Price</label>
                                            <input type="number" class="form-control" name="regularPrice"
                                                placeholder="0.00" step="0.01">
                                            <div id="regularPrice-error" class="error-message"></div>
                                        </div>
                                        <div class="col-4 mb-3">
                                            <label class="form-label">Sale Price</label>
                                            <input type="number" class="form-control" name="salePrice"
                                                placeholder="0.00" step="0.01">
                                            <div id="salePrice-error" class="error-message"></div>
                                        </div>
                                        <div class="col-4 mb-3">
                                            <label class="form-label">Qty</label>
                                            <input type="number" class="form-control" name="quantity" placeholder="0">
                                            <div id="quantity-error" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" name="isReturnable"
                                            id="isReturnable" value="true" checked>
                                        <label class="form-check-label small" for="isReturnable">Product is
                                            Returnable</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Product Images</div>
                            <div class="thumbnails-container" id="thumbnailsContainer"></div>
                            <div class="image-upload-container" onclick="document.getElementById('imageInput').click()">
                                <div class="image-upload-icon">ðŸ“¸</div>
                                <input type="file" class="form-control" id="imageInput"
                                    accept="image/png, image/jpeg, image/jpg" onchange="handleImageSelect(event)">
                                <div class="image-upload-text">Choose product images</div>
                                <div id="images-error" class="error-message"></div>
                            </div>
                            <input type="hidden" name="images" id="selectedImages">
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-gold btn-lg w-100" type="submit">
                                <span id="submitText">Publish Product</span>
                                <span id="submitSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    </div>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="cropImage" alt="Image to crop" style="max-width: 100%; display: block;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="cropButton">
                        <span id="cropButtonText">Crop & Save</span>
                        <span id="cropButtonSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for cropping operations -->
    <canvas id="cropCanvas" style="display: none;"></canvas>

    <script>
        (function () {
            let selectedFiles = [];
            let currentFile = null;
            let cropper = null;
            let isProcessing = false;
            let cropModal = null;

            window.initAddProduct = function () {
                const modalElement = document.getElementById('cropModal');
                if (modalElement) {
                    cropModal = bootstrap.Modal.getInstance(modalElement);
                    if (!cropModal) cropModal = new bootstrap.Modal(modalElement);
                }

                // Attach events
                const modalEl = document.getElementById('cropModal');
                if (modalEl) {
                    modalEl.addEventListener('shown.bs.modal', onModalShown);
                    modalEl.addEventListener('hidden.bs.modal', onModalHidden);
                }

                const cropBtn = document.getElementById('cropButton');
                if (cropBtn) {
                    cropBtn.onclick = onCropButtonClick;
                }
            };

            window.handleImageSelect = function (event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                if (selectedFiles.length >= 4) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Maximum Images Reached',
                        text: 'You can only upload up to 4 images per product'
                    });
                    event.target.value = '';
                    return;
                }

                const file = files[0];
                if (!file.type.startsWith('image/')) {
                    Swal.fire({ icon: 'error', title: 'Invalid File', text: 'Please select an image file' });
                    event.target.value = '';
                    return;
                }

                currentFile = file;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const image = document.getElementById('cropImage');
                    if (image) {
                        image.src = e.target.result;
                        if (!cropModal) window.initAddProduct();
                        if (cropModal) cropModal.show();
                    }
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            };

            function onModalShown() {
                if (typeof Cropper === 'undefined') {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Cropper library failed to load.' });
                    return;
                }

                const image = document.getElementById('cropImage');
                if (!image || !image.src) return;

                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }

                setTimeout(() => {
                    cropper = new Cropper(image, {
                        viewMode: 1,
                        aspectRatio: NaN,
                        autoCropArea: 0.8,
                        dragMode: 'crop',
                        background: true,
                        movable: true,
                        rotatable: true,
                        scalable: true,
                        zoomable: true
                    });
                }, 200);
            }

            function onModalHidden() {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                const image = document.getElementById('cropImage');
                if (image) image.src = '';
                currentFile = null;
                isProcessing = false;

                const button = document.getElementById('cropButton');
                const text = document.getElementById('cropButtonText');
                const spinner = document.getElementById('cropButtonSpinner');
                if (button && text && spinner) {
                    button.disabled = false;
                    text.classList.remove('d-none');
                    spinner.classList.add('d-none');
                }
            }

            async function onCropButtonClick() {
                if (!cropper || !currentFile || isProcessing) return;

                isProcessing = true;
                const button = document.getElementById('cropButton');
                const text = document.getElementById('cropButtonText');
                const spinner = document.getElementById('cropButtonSpinner');

                if (button && text && spinner) {
                    button.disabled = true;
                    text.classList.add('d-none');
                    spinner.classList.remove('d-none');
                }

                try {
                    const canvas = cropper.getCroppedCanvas({
                        maxWidth: 1200,
                        maxHeight: 1200,
                        fillColor: '#fff'
                    });

                    if (!canvas) throw new Error('Failed to create canvas');

                    const blob = await new Promise(resolve => canvas.toBlob(resolve, currentFile.type, 0.9));
                    const croppedFile = new File([blob], currentFile.name, { type: currentFile.type });
                    const preview = canvas.toDataURL(currentFile.type, 0.9);

                    selectedFiles.push({ file: croppedFile, preview: preview });
                    window.updateThumbnails();

                    if (cropModal) cropModal.hide();

                    Swal.fire({
                        icon: 'success',
                        title: 'Image Added',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error('Error cropping:', error);
                    Swal.fire({ icon: 'error', title: 'Cropping Failed' });
                } finally {
                    isProcessing = false;
                }
            }

            window.updateThumbnails = function () {
                const container = document.getElementById('thumbnailsContainer');
                if (!container) return;
                container.innerHTML = '';

                selectedFiles.forEach((item, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'thumbnail-wrapper';

                    const img = document.createElement('img');
                    img.src = item.preview;
                    img.className = 'thumbnail';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = 'Ã—';
                    deleteBtn.type = 'button';
                    deleteBtn.onclick = (e) => {
                        e.preventDefault();
                        window.deleteImage(index);
                    };

                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    container.appendChild(wrapper);
                });

                const errorElement = document.getElementById('images-error');
                if (errorElement) {
                    const remaining = 4 - selectedFiles.length;
                    if (remaining > 0) {
                        errorElement.textContent = `You can upload ${remaining} more images`;
                        errorElement.style.color = '#6c757d';
                    } else {
                        errorElement.textContent = 'Maximum images reached';
                        errorElement.style.color = '#dc3545';
                    }
                    errorElement.style.display = 'block';
                }
            };

            window.deleteImage = function (index) {
                Swal.fire({
                    title: 'Delete Image?',
                    icon: 'warning',
                    showCancelButton: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        selectedFiles.splice(index, 1);
                        window.updateThumbnails();
                    }
                });
            };

            window.validateForm = function () {
                window.clearErrorMessages();
                let isValid = true;

                const name = document.getElementById('product_name').value.trim();
                if (name === '') {
                    window.displayErrorMessage('productName-error', 'Product name is required');
                    isValid = false;
                }

                const description = document.getElementById('descriptionid').value.trim();
                if (description === '' || description.length < 20) {
                    window.displayErrorMessage('description-error', 'Description (min 20 chars) is required');
                    isValid = false;
                }

                const brand = document.querySelector('select[name="brand"]').value;
                if (!brand) {
                    window.displayErrorMessage('brand-error', 'Brand is required');
                    isValid = false;
                }

                const category = document.querySelector('select[name="category"]').value;
                if (!category) {
                    window.displayErrorMessage('category-error', 'Category is required');
                    isValid = false;
                }

                const regularPrice = parseFloat(document.getElementsByName('regularPrice')[0].value);
                if (isNaN(regularPrice) || regularPrice <= 0) {
                    window.displayErrorMessage('regularPrice-error', 'Provide a positive regular price');
                    isValid = false;
                }

                const qty = parseInt(document.getElementsByName('quantity')[0].value);
                if (isNaN(qty) || qty < 0) {
                    window.displayErrorMessage('quantity-error', 'Quantity is required');
                    isValid = false;
                }

                if (selectedFiles.length < 3) {
                    window.displayErrorMessage('images-error', 'Minimum 3 images required');
                    isValid = false;
                }

                return isValid;
            };

            window.displayErrorMessage = function (id, msg) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = msg;
                    el.style.display = 'block';
                }
            };

            window.clearErrorMessages = function () {
                const errs = document.querySelectorAll('.error-message');
                errs.forEach(el => {
                    el.textContent = '';
                    el.style.display = 'none';
                });
            };

            window.handleFormSubmit = async function (event) {
                event.preventDefault();
                if (!window.validateForm()) return false;

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const submitText = document.getElementById('submitText');
                const submitSpinner = document.getElementById('submitSpinner');

                if (submitBtn) submitBtn.disabled = true;
                if (submitText) submitText.textContent = 'Publishing...';
                if (submitSpinner) submitSpinner.classList.remove('d-none');

                try {
                    const formData = new FormData(event.target);
                    formData.delete('images');
                    selectedFiles.forEach((item, index) => {
                        formData.append('images', item.file, `product_image_${index}.jpg`);
                    });

                    const response = await fetch('/admin/addProducts', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await Swal.fire({ icon: 'success', title: 'Product Added' });
                        if (window.loadContent) {
                            window.loadContent('/admin/products');
                        } else {
                            window.location.href = '/admin/products';
                        }
                    } else {
                        throw new Error(data.error || 'Failed to add product');
                    }
                } catch (error) {
                    Swal.fire({ icon: 'error', title: 'Error', text: error.message });
                } finally {
                    if (submitBtn) submitBtn.disabled = false;
                    if (submitText) submitText.textContent = 'Publish Product';
                    if (submitSpinner) submitSpinner.classList.add('d-none');
                }
                return false;
            };

            // Initialize
            window.initAddProduct();
        })();
    </script>
    <%- include("../../views/partials/admin/footer") %>