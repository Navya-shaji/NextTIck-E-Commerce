<%- include("../../views/partials/admin/header") %>

    <style>
        .content-wrapper {
            padding: 2.5rem;
            background-color: var(--admin-bg);
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .premium-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        /* Orders Table */
        .orders-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: #f8fafc;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 1.25rem 1.5rem;
            border: none;
        }

        .table tbody td {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
            border-top: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #334155;
        }

        /* Status Select */
        .status-select {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.4rem 2rem 0.4rem 0.8rem;
            font-size: 0.85rem;
            background-color: #f8fafc;
            cursor: pointer;
            width: 140px;
        }

        .status-select:focus {
            border-color: var(--accent-gold);
            outline: none;
        }

        /* Action Buttons */
        .btn-view {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            background: #fff;
            color: var(--text-dark);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .btn-view:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-cancel {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #fffafa;
            color: #ef4444;
            border: 1px solid #fee2e2;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }

        .btn-cancel:hover {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .btn-delete {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f87171;
            color: #fff;
            border: 1px solid #ef4444;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }

        .btn-delete:hover {
            background: #ef4444;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Pagination */
        .pagination-wrap {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
        }

        .page-link {
            border: none;
            color: #64748b;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin: 0 2px;
        }

        .page-item.active .page-link {
            background: var(--accent-gold);
            color: white;
        }
    </style>

    <div class="content-wrapper">
        <div class="content-header">
            <h2 class="content-title">Order Management</h2>
        </div>

        <!-- Order Summary Section -->
        <div class="summary-grid">
            <div class="premium-card">
                <p class="card-label">Total Orders</p>
                <h3 class="card-value">
                    <%= totalOrders %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Active Revenue</p>
                <h3 class="card-value" style="color: #10b981;">₹<%= activeRevenue.toLocaleString('en-IN') %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Total Revenue</p>
                <h3 class="card-value">₹<%= totalRevenue.toLocaleString('en-IN') %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Pending</p>
                <h3 class="card-value" style="color: #f59e0b;">
                    <%= pendingOrders %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Completed</p>
                <h3 class="card-value" style="color: #3b82f6;">
                    <%= completedOrders %>
                </h3>
            </div>
        </div>

        <!-- Orders Table Section -->
        <div class="orders-card">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% orders.forEach(order=> { %>
                            <tr>
                                <td class="fw-bold text-dark">#<%= order.orderId %>
                                </td>
                                <td>
                                    <%= order.userName || 'Guest' %>
                                </td>
                                <td class="text-muted">
                                    <%= new Date(order.createdOn).toLocaleDateString() %>
                                </td>
                                <td>
                                    <select class="form-select status-select" data-order-id="<%= order._id %>"
                                        <%=['Delivered', 'Cancelled' , 'Returned' ].includes(order.status) ? 'disabled'
                                        : '' %>>
                                        <option value="Pending" <%=order.status==='Pending' ? 'selected' : '' %>>Pending
                                        </option>
                                        <option value="Processing" <%=order.status==='Processing' ? 'selected' : '' %>
                                            >Processing</option>
                                        <option value="Shipped" <%=order.status==='Shipped' ? 'selected' : '' %>>Shipped
                                        </option>
                                        <option value="Delivered" <%=order.status==='Delivered' ? 'selected' : '' %>
                                            >Delivered</option>
                                        <option value="Cancelled" <%=order.status==='Cancelled' ? 'selected' : '' %>
                                            >Cancelled</option>
                                        <option value="Return Request" <%=order.status==='Return Request' ? 'selected'
                                            : '' %>>Return Request</option>
                                        <option value="Returned" <%=order.status==='Returned' ? 'selected' : '' %>
                                            >Returned</option>
                                    </select>
                                </td>
                                <td class="fw-bold">₹<%= order.finalAmount.toFixed(2) %>
                                </td>
                                <td class="text-end">
                                    <a href="/admin/orders/<%= order._id %>" class="btn-view">
                                        Details
                                    </a>
                                    <% if (!['Delivered', 'Cancelled' , 'Returned' ].includes(order.status)) { %>
                                        <button onclick="cancelOrder('<%= order._id %>')" class="btn-cancel">
                                            Cancel
                                        </button>
                                        <% } %>
                                            <button onclick="deleteOrder('<%= order._id %>')" class="btn-delete">
                                                Delete
                                            </button>
                                </td>
                            </tr>
                            <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <% if (totalPages> 1) { %>
            <div class="pagination-wrap">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <% if (currentPage> 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage - 1 %>"><i
                                        class="fas fa-chevron-left"></i></a>
                            </li>
                            <% } %>

                                <% for (let i=1; i <=totalPages; i++) { %>
                                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                    <% } %>

                                        <% if (currentPage < totalPages) { %>
                                            <li class="page-item">
                                                <a class="page-link" href="?page=<%= currentPage + 1 %>"><i
                                                        class="fas fa-chevron-right"></i></a>
                                            </li>
                                            <% } %>
                    </ul>
                </nav>
            </div>
            <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Define the ordered statuses (Simplified for UI logic)
            const statusOrder = ["Pending", "Processing", "Shipped", "Delivered", "Cancelled", "Return Request", "Returned"];

            document.querySelectorAll('.status-select').forEach(select => {
                // Store initial value
                select.dataset.originalValue = select.value;

                select.addEventListener('change', async function () {
                    const orderId = this.dataset.orderId;
                    const newStatus = this.value;
                    const currentStatus = this.dataset.originalValue;

                    // Basic validation (backend should also handle this)
                    // if (statusOrder.indexOf(newStatus) < statusOrder.indexOf(currentStatus)) { ... }
                    // We'll trust the backend response mostly, but prevent obvious UI mistakes if needed.

                    try {
                        const response = await fetch('/admin/orders/update-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderId, status: newStatus }),
                        });

                        const data = await response.json();

                        if (data.success) {
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            })

                            Toast.fire({
                                icon: 'success',
                                title: 'Order status updated'
                            })

                            // Update original value to the new successful status
                            this.dataset.originalValue = newStatus;

                            // Disable if final status
                            if (["Delivered", "Cancelled", "Returned"].includes(newStatus)) {
                                this.disabled = true;
                            }

                        } else {
                            Swal.fire({
                                title: 'Update Failed',
                                text: data.message || 'Could not update status',
                                icon: 'error',
                                confirmButtonColor: '#1e293b'
                            });
                            this.value = currentStatus;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Network error occurred',
                            icon: 'error'
                        });
                        this.value = currentStatus;
                    }
                });
            });
        });

        async function cancelOrder(orderId) {
            const { value: reason } = await Swal.fire({
                title: 'Cancel Order?',
                input: 'textarea',
                inputLabel: 'Reason for cancellation',
                inputPlaceholder: 'Enter reason here...',
                inputAttributes: {
                    'aria-label': 'Enter reason here'
                },
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Confirm Cancellation',
                inputValidator: (value) => {
                    if (!value) {
                        return 'You need to provide a reason!'
                    }
                }
            });

            if (reason) {
                try {
                    const response = await fetch('/admin/orders/cancel-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, reason })
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            title: 'Cancelled!',
                            text: 'Order has been cancelled.',
                            icon: 'success',
                            confirmButtonColor: '#1e293b'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', data.message || 'Failed to cancel order', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Network error occurred', 'error');
                }
            }
        }

        async function deleteOrder(orderId) {
            const res = await Swal.fire({
                title: 'Delete Order?',
                text: 'This will permanently remove the order record!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, delete it!'
            });

            if (res.isConfirmed) {
                try {
                    const response = await fetch('/admin/orders/delete-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Order has been permanently deleted.',
                            icon: 'success',
                            confirmButtonColor: '#1e293b'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', data.message || 'Failed to delete order', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Network error occurred', 'error');
                }
            }
        }
    </script>

    <%- include("../../views/partials/admin/footer") %>