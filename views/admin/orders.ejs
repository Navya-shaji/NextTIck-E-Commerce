<%- include("../../views/partials/admin/header") %>

    <style>
        .content-wrapper {
            padding: 2.5rem;
            background-color: var(--admin-bg);
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .premium-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        /* Orders Table */
        .orders-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: #f8fafc;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 1.25rem 1.5rem;
            border: none;
        }

        .table tbody td {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
            border-top: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #334155;
        }

        /* Status Badge Styling */
        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-processing {
            background: #e0f2fe;
            color: #075985;
        }

        .badge-shipped {
            background: #ede9fe;
            color: #5b21b6;
        }

        .badge-delivered {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-returned {
            background: #f1f5f9;
            color: #475569;
        }

        /* Status Select */
        .status-select-wrap {
            position: relative;
            width: 140px;
        }

        .status-select {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            background-color: #f8fafc;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        .status-select:focus {
            border-color: var(--accent-gold);
            outline: none;
            box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
        }

        /* Action Dropdown */
        .action-dropdown-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-dropdown-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #1e293b;
        }

        .dropdown-menu {
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            min-width: 160px;
        }

        .dropdown-item {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
            color: #475569;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .dropdown-item:hover {
            background: #f8fafc;
            color: #1e293b;
        }

        .dropdown-item i {
            width: 1.25rem;
            font-size: 0.9rem;
        }

        .dropdown-item.text-danger:hover {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Pagination */
        .pagination-wrap {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
        }

        .page-link {
            border: none;
            color: #64748b;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin: 0 2px;
            transition: all 0.2s;
        }

        .page-link:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .page-item.active .page-link {
            background: var(--accent-gold);
            color: white;
        }
    </style>

    <div class="content-wrapper">
        <div class="content-header">
            <h2 class="content-title">Order Management</h2>
        </div>

        <!-- Order Summary Section -->
        <div class="summary-grid">
            <div class="premium-card">
                <p class="card-label">Total Orders</p>
                <h3 class="card-value">
                    <%= totalOrders %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Active Revenue</p>
                <h3 class="card-value" style="color: #10b981;">₹<%= activeRevenue.toLocaleString('en-IN') %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Total Revenue</p>
                <h3 class="card-value">₹<%= totalRevenue.toLocaleString('en-IN') %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Pending</p>
                <h3 class="card-value" style="color: #f59e0b;">
                    <%= pendingOrders %>
                </h3>
            </div>
            <div class="premium-card">
                <p class="card-label">Completed</p>
                <h3 class="card-value" style="color: #3b82f6;">
                    <%= completedOrders %>
                </h3>
            </div>
        </div>

        <!-- Orders Table Section -->
        <div class="orders-card">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% orders.forEach(order=> { %>
                            <tr>
                                <td class="fw-bold text-dark">#<%= order.orderId %>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">
                                            <%= order.userName || 'Guest' %>
                                        </span>
                                        <small class="text-muted">
                                            <%= order.userId?.email %>
                                        </small>
                                    </div>
                                </td>
                                <td class="text-muted">
                                    <%= new Date(order.createdOn).toLocaleDateString(undefined, { day: '2-digit' ,
                                        month: 'short' , year: 'numeric' }) %>
                                </td>
                                <td>
                                    <div class="status-select-wrap">
                                        <select class="form-select status-select" data-order-id="<%= order._id %>"
                                            <%=['Delivered', 'Cancelled' , 'Returned' ].includes(order.status)
                                            ? 'disabled' : '' %>>
                                            <option value="Pending" <%=order.status==='Pending' ? 'selected' : '' %>
                                                >Pending</option>
                                            <option value="Processing" <%=order.status==='Processing' ? 'selected' : ''
                                                %>>Processing</option>
                                            <option value="Shipped" <%=order.status==='Shipped' ? 'selected' : '' %>
                                                >Shipped</option>
                                            <option value="Delivered" <%=order.status==='Delivered' ? 'selected' : '' %>
                                                >Delivered</option>
                                            <option value="Cancelled" <%=order.status==='Cancelled' ? 'selected' : '' %>
                                                >Cancelled</option>
                                            <option value="Return Request" <%=order.status==='Return Request'
                                                ? 'selected' : '' %>>Return Request</option>
                                            <option value="Returned" <%=order.status==='Returned' ? 'selected' : '' %>
                                                >Returned</option>
                                        </select>
                                    </div>
                                </td>
                                <td class="fw-bold">₹<%= order.finalAmount.toLocaleString('en-IN') %>
                                </td>
                                <td class="text-end">
                                    <div class="dropdown">
                                        <button class="action-dropdown-btn" type="button" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            Actions <i class="fas fa-chevron-down ms-1"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="/admin/orders/<%= order._id %>">
                                                    <i class="fas fa-eye me-2"></i>Order Details
                                                </a>
                                            </li>
                                            <% if (!['Delivered', 'Cancelled' , 'Returned' ].includes(order.status)) {
                                                %>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#"
                                                        onclick="cancelOrder('<%= order._id %>'); return false;">
                                                        <i class="fas fa-times me-2"></i>Cancel Order
                                                    </a>
                                                </li>
                                                <% } %>
                                                    <li>
                                                        <hr class="dropdown-divider">
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#"
                                                            onclick="deleteOrder('<%= order._id %>'); return false;">
                                                            <i class="fas fa-trash-alt me-2"></i>Delete Record
                                                        </a>
                                                    </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <% if (totalPages> 1) { %>
            <div class="pagination-wrap">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <% if (currentPage> 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage - 1 %>"><i
                                        class="fas fa-chevron-left"></i></a>
                            </li>
                            <% } %>

                                <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages,
                                    currentPage + 2); if (currentPage <=3) { endPage=Math.min(totalPages, 5); } if
                                    (currentPage> totalPages - 3) {
                                    startPage = Math.max(1, totalPages - 4);
                                    }
                                    %>

                                    <% if (startPage> 1) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1">1</a>
                                        </li>
                                        <% if (startPage> 2) { %>
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                            <% } %>
                                                <% } %>

                                                    <% for (let i=startPage; i <=endPage; i++) { %>
                                                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                            <a class="page-link" href="?page=<%= i %>">
                                                                <%= i %>
                                                            </a>
                                                        </li>
                                                        <% } %>

                                                            <% if (endPage < totalPages) { %>
                                                                <% if (endPage < totalPages - 1) { %>
                                                                    <li class="page-item disabled"><span
                                                                            class="page-link">...</span></li>
                                                                    <% } %>
                                                                        <li class="page-item">
                                                                            <a class="page-link"
                                                                                href="?page=<%= totalPages %>">
                                                                                <%= totalPages %>
                                                                            </a>
                                                                        </li>
                                                                        <% } %>

                                                                            <% if (currentPage < totalPages) { %>
                                                                                <li class="page-item">
                                                                                    <a class="page-link"
                                                                                        href="?page=<%= currentPage + 1 %>"><i
                                                                                            class="fas fa-chevron-right"></i></a>
                                                                                </li>
                                                                                <% } %>
                    </ul>
                </nav>
            </div>
            <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Define the ordered statuses (Simplified for UI logic)
            function updateSelectStyle(select) {
                const status = select.value;
                // Remove all possible status classes
                select.classList.remove('badge-pending', 'badge-processing', 'badge-shipped', 'badge-delivered', 'badge-cancelled', 'badge-returned');

                // Add the appropriate class
                if (status === 'Pending') select.classList.add('badge-pending');
                else if (status === 'Processing') select.classList.add('badge-processing');
                else if (status === 'Shipped') select.classList.add('badge-shipped');
                else if (status === 'Delivered') select.classList.add('badge-delivered');
                else if (status === 'Cancelled') select.classList.add('badge-cancelled');
                else if (status === 'Return Request' || status === 'Returned') select.classList.add('badge-returned');
            }

            document.querySelectorAll('.status-select').forEach(select => {
                // Initialize style
                updateSelectStyle(select);

                // Store initial value
                select.dataset.originalValue = select.value;

                select.addEventListener('change', async function () {
                    const orderId = this.dataset.orderId;
                    const newStatus = this.value;
                    const currentStatus = this.dataset.originalValue;

                    try {
                        const response = await fetch('/admin/orders/update-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderId, status: newStatus }),
                        });

                        const data = await response.json();

                        if (data.success) {
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            })

                            Toast.fire({
                                icon: 'success',
                                title: 'Order status updated'
                            })

                            // Update style
                            updateSelectStyle(this);

                            // Update original value to the new successful status
                            this.dataset.originalValue = newStatus;

                            // Disable if final status
                            if (["Delivered", "Cancelled", "Returned"].includes(newStatus)) {
                                this.disabled = true;
                            }

                        } else {
                            Swal.fire({
                                title: 'Update Failed',
                                text: data.message || 'Could not update status',
                                icon: 'error',
                                confirmButtonColor: '#1e293b'
                            });
                            this.value = currentStatus;
                            updateSelectStyle(this);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Network error occurred',
                            icon: 'error'
                        });
                        this.value = currentStatus;
                        updateSelectStyle(this);
                    }
                });
            });
        });

        async function cancelOrder(orderId) {
            const { value: reason } = await Swal.fire({
                title: 'Cancel Order?',
                input: 'textarea',
                inputLabel: 'Reason for cancellation',
                inputPlaceholder: 'Enter reason here...',
                inputAttributes: {
                    'aria-label': 'Enter reason here'
                },
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Confirm Cancellation',
                inputValidator: (value) => {
                    if (!value) {
                        return 'You need to provide a reason!'
                    }
                }
            });

            if (reason) {
                try {
                    const response = await fetch('/admin/orders/cancel-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, reason })
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            title: 'Cancelled!',
                            text: 'Order has been cancelled.',
                            icon: 'success',
                            confirmButtonColor: '#1e293b'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', data.message || 'Failed to cancel order', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Network error occurred', 'error');
                }
            }
        }

        async function deleteOrder(orderId) {
            const res = await Swal.fire({
                title: 'Delete Order?',
                text: 'This will permanently remove the order record!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, delete it!'
            });

            if (res.isConfirmed) {
                try {
                    const response = await fetch('/admin/orders/delete-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Order has been permanently deleted.',
                            icon: 'success',
                            confirmButtonColor: '#1e293b'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', data.message || 'Failed to delete order', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Network error occurred', 'error');
                }
            }
        }
    </script>

    <%- include("../../views/partials/admin/footer") %>