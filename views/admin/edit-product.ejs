<%- include("../../views/partials/admin/header") %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <link rel="stylesheet" href="../../styles/add-Products.css">

    <section class="content-main">
        <div class="row">
            <div class="col-12">
                <div class="content-header">
                    <h2 class="content-title">Edit Product</h2>
                </div>
            </div>
            <div class="col-lg-8">
                <form method="post" action="/admin/product/edit/<%= product._id %>" id="editProductForm"
                    onsubmit="return handleFormSubmit(event)">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 bordered-section">
                                    <div class="form-section">
                                        <div class="form-section-title">Basic Information</div>
                                        <div class="mb-3">
                                            <label for="product_name" class="form-label">Product Name</label>
                                            <input type="text" placeholder="Enter product name" name="productName"
                                                class="form-control" id="product_name"
                                                value="<%= product.productName %>">
                                            <div id="productName-error" class="error-message"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="descriptionid" class="form-label">Description</label>
                                            <textarea class="form-control" id="descriptionid" name="description"
                                                rows="3"
                                                placeholder="Enter product description"><%= product.description %></textarea>
                                            <div id="description-error" class="error-message"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-section">
                                        <div class="form-section-title">Product Details</div>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Brand</label>
                                                <select class="form-select" name="brand">
                                                    <option value="">Select Brand</option>
                                                    <% if (typeof brand !=='undefined' && brand.length> 0) { %>
                                                        <% for(let i=0; i < brand.length; i++) { %>
                                                            <option value="<%= brand[i]._id %>" <%=(product.brand &&
                                                                product.brand._id &&
                                                                product.brand._id.toString()===brand[i]._id.toString())
                                                                ? 'selected' : '' %>>
                                                                <%= brand[i].brandName %>
                                                            </option>
                                                            <% } %>
                                                                <% } %>
                                                </select>
                                                <div id="brand-error" class="error-message"></div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" name="category">
                                                    <option value="">Select Category</option>
                                                    <% if (typeof cat !=='undefined' && cat.length> 0) { %>
                                                        <% for(let i=0; i < cat.length; i++) { %>
                                                            <option value="<%= cat[i].name %>" <%=(product.category &&
                                                                product.category.name===cat[i].name) ? 'selected' : ''
                                                                %>>
                                                                <%= cat[i].name %>
                                                            </option>
                                                            <% } %>
                                                                <% } %>
                                                </select>
                                                <div id="category-error" class="error-message"></div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-4 mb-3">
                                                <label class="form-label">Regular Price</label>
                                                <input type="number" class="form-control" name="regularPrice"
                                                    value="<%= product.regularPrice %>" placeholder="0.00" step="0.01">
                                                <div id="regularPrice-error" class="error-message"></div>
                                            </div>
                                            <div class="col-4 mb-3">
                                                <label class="form-label">Sale Price</label>
                                                <input type="number" class="form-control" name="salePrice"
                                                    value="<%= product.salesPrice %>" placeholder="0.00" step="0.01">
                                                <div id="salePrice-error" class="error-message"></div>
                                            </div>
                                            <div class="col-4 mb-3">
                                                <label class="form-label">Qty</label>
                                                <input type="number" class="form-control" name="quantity"
                                                    value="<%= product.quantity %>" placeholder="0">
                                                <div id="quantity-error" class="error-message"></div>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch mt-2">
                                            <input class="form-check-input" type="checkbox" name="isReturnable"
                                                id="isReturnable" value="true" <%=product.isReturnable ? 'checked' : ''
                                                %>>
                                            <label class="form-check-label small" for="isReturnable">Product is
                                                Returnable</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="form-section-title">Product Images</div>
                                <div class="thumbnails-container" id="thumbnailsContainer">
                                    <% for(let i=0; i < product.productImage.length; i++) { %>
                                        <div class="thumbnail-wrapper" data-image="<%= product.productImage[i] %>">
                                            <img src="/uploads/re-image/<%= product.productImage[i] %>"
                                                class="thumbnail" alt="Product image">
                                            <button type="button" class="delete-btn"
                                                onclick="deleteExistingImage('<%= product.productImage[i] %>', '<%= product._id %>')">Ã—</button>
                                        </div>
                                        <% } %>
                                </div>
                                <div class="image-upload-container"
                                    onclick="document.getElementById('imageInput').click()">
                                    <div class="image-upload-icon">ðŸ“¸</div>
                                    <input type="file" class="form-control" id="imageInput"
                                        accept="image/png, image/jpeg, image/jpg" onchange="handleImageSelect(event)">
                                    <div class="image-upload-text">Add more images (Max 4 total)</div>
                                    <div id="images-error" class="error-message"></div>
                                </div>
                            </div>

                            <div>
                                <button class="btn btn-primary btn-lg" type="submit">
                                    <i class="fas fa-save me-1"></i>
                                    <span id="submitText">Update Product</span>
                                    <span id="submitSpinner"
                                        class="spinner-border spinner-border-sm d-none ms-2"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropModalLabel">Crop New Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="cropImage" alt="Image to crop" style="max-width: 100%; display: block;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="cropButton">
                        <span id="cropButtonText">Crop & Upload</span>
                        <span id="cropButtonSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    <script>
        (function () {
            let cropper = null;
            let currentFile = null;
            let isProcessing = false;
            let cropModal = null;

            window.initEditProduct = function () {
                const modalElement = document.getElementById('cropModal');
                if (modalElement) {
                    cropModal = bootstrap.Modal.getInstance(modalElement);
                    if (!cropModal) cropModal = new bootstrap.Modal(modalElement);

                    // Re-initialize cropper when modal is shown
                    modalElement.removeEventListener('shown.bs.modal', setupCropper);
                    modalElement.addEventListener('shown.bs.modal', setupCropper);
                }
            };

            function setupCropper() {
                if (cropper) cropper.destroy();
                const image = document.getElementById('cropImage');
                cropper = new Cropper(image, {
                    viewMode: 1,
                    aspectRatio: NaN,
                    autoCropArea: 0.8,
                    dragMode: 'crop'
                });
            }

            window.handleImageSelect = function (event) {
                const existingImagesCount = document.querySelectorAll('.thumbnail-wrapper').length;
                const files = event.target.files;

                if (!files || files.length === 0) return;

                if (existingImagesCount >= 4) {
                    Swal.fire('Warning', 'Maximum 4 images allowed', 'warning');
                    event.target.value = '';
                    return;
                }

                const file = files[0];
                if (!file.type.startsWith('image/')) {
                    Swal.fire('Error', 'Please select an image file', 'error');
                    event.target.value = '';
                    return;
                }

                currentFile = file;
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('cropImage').src = e.target.result;
                    if (cropModal) cropModal.show();
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            const cropBtn = document.getElementById('cropButton');
            if (cropBtn) {
                cropBtn.onclick = async function () {
                    if (!cropper || isProcessing) return;

                    isProcessing = true;
                    const button = this;
                    const text = document.getElementById('cropButtonText');
                    const spinner = document.getElementById('cropButtonSpinner');

                    button.disabled = true;
                    text.classList.add('d-none');
                    spinner.classList.remove('d-none');

                    try {
                        const canvas = cropper.getCroppedCanvas({
                            maxWidth: 1200,
                            maxHeight: 1200
                        });

                        canvas.toBlob(async (blob) => {
                            const croppedFile = new File([blob], currentFile.name, { type: currentFile.type });
                            const formData = new FormData();
                            formData.append('images', croppedFile);
                            formData.append('productId', '<%= product._id %>');

                            const response = await fetch('/admin/addProductImage', {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();
                            if (data.success) {
                                const container = document.getElementById('thumbnailsContainer');
                                const wrapper = document.createElement('div');
                                wrapper.className = 'thumbnail-wrapper';
                                wrapper.dataset.image = data.imageName;
                                wrapper.innerHTML = `
                                <img src="/uploads/re-image/${data.imageName}" class="thumbnail">
                                <button type="button" class="delete-btn" onclick="deleteExistingImage('${data.imageName}', '<%= product._id %>')">Ã—</button>
                            `;
                                container.appendChild(wrapper);
                                if (cropModal) cropModal.hide();
                                Swal.fire({ icon: 'success', title: 'Image Uploaded', timer: 1500, showConfirmButton: false });
                            } else {
                                throw new Error(data.message || 'Upload failed');
                            }
                        }, currentFile.type);

                    } catch (error) {
                        Swal.fire('Error', error.message, 'error');
                    } finally {
                        button.disabled = false;
                        text.classList.remove('d-none');
                        spinner.classList.add('d-none');
                        isProcessing = false;
                    }
                };
            }

            window.deleteExistingImage = async function (imageName, productId) {
                const result = await Swal.fire({
                    title: 'Delete Image?',
                    text: 'This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545'
                });

                if (result.isConfirmed) {
                    try {
                        const response = await fetch('/admin/deleteImage', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ imageName, productId })
                        });
                        const data = await response.json();
                        if (data.success) {
                            const el = document.querySelector(`.thumbnail-wrapper[data-image="${imageName}"]`);
                            if (el) el.remove();
                            Swal.fire({ icon: 'success', title: 'Deleted', timer: 1000, showConfirmButton: false });
                        }
                    } catch (error) {
                        Swal.fire('Error', 'Deletion failed', 'error');
                    }
                }
            }

            function validateForm() {
                clearErrorMessages();
                let isValid = true;

                const name = document.getElementById('product_name').value.trim();
                if (!name || name.length < 3) {
                    displayErrorMessage('productName-error', 'Product name must be at least 3 characters');
                    isValid = false;
                }

                const desc = document.getElementById('descriptionid').value.trim();
                if (!desc || desc.length < 20) {
                    displayErrorMessage('description-error', 'Description must be at least 20 characters');
                    isValid = false;
                }

                const brand = document.querySelector('select[name="brand"]').value;
                if (!brand) {
                    displayErrorMessage('brand-error', 'Brand is required');
                    isValid = false;
                }

                const category = document.querySelector('select[name="category"]').value;
                if (!category) {
                    displayErrorMessage('category-error', 'Category is required');
                    isValid = false;
                }

                const regPrice = parseFloat(document.getElementsByName('regularPrice')[0].value);
                if (isNaN(regPrice) || regPrice <= 0) {
                    displayErrorMessage('regularPrice-error', 'Enter valid regular price');
                    isValid = false;
                }

                const salePriceVal = document.getElementsByName('salePrice')[0].value.trim();
                if (salePriceVal !== '') {
                    const salePrice = parseFloat(salePriceVal);
                    if (isNaN(salePrice) || salePrice <= 0 || salePrice >= regPrice) {
                        displayErrorMessage('salePrice-error', 'Sale price must be positive and less than regular price');
                        isValid = false;
                    }
                }

                const qty = parseInt(document.getElementsByName('quantity')[0].value);
                if (isNaN(qty) || qty < 0) {
                    displayErrorMessage('quantity-error', 'Quantity must be 0 or more');
                    isValid = false;
                }

                return isValid;
            }

            function displayErrorMessage(id, msg) {
                const el = document.getElementById(id);
                if (el) { el.textContent = msg; el.style.display = 'block'; }
            }

            function clearErrorMessages() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                    el.style.display = 'none';
                });
            }

            window.handleFormSubmit = async function (event) {
                event.preventDefault();
                if (!validateForm()) return false;

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const submitText = document.getElementById('submitText');
                const submitSpinner = document.getElementById('submitSpinner');

                submitBtn.disabled = true;
                submitText.textContent = 'Updating...';
                submitSpinner.classList.remove('d-none');

                try {
                    const formData = new URLSearchParams(new FormData(event.target));
                    const response = await fetch(event.target.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        await Swal.fire({ icon: 'success', title: 'Success!', text: 'Product updated successfully' });
                        if (window.loadContent) {
                            window.loadContent('/admin/products');
                        } else {
                            window.location.href = '/admin/products';
                        }
                    } else {
                        throw new Error(data.message || 'Update failed');
                    }
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitText.textContent = 'Update Product';
                    submitSpinner.classList.add('d-none');
                }
            }

            window.initEditProduct();
        })();
    </script>
    <%- include("../../views/partials/admin/footer") %>