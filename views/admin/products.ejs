<%- include("../../views/partials/admin/header") %>
    <style>
        .content-wrapper {
            padding: 2.5rem;
            background-color: var(--admin-bg);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .content-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        /* Search Section */
        .search-container {
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* Product Card */
        .product-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        /* Table Styling */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: #f8fafc;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 1rem 1.5rem;
            border: none;
        }

        .table tbody td {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
            border-top: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #334155;
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-active {
            background: #ecfdf5;
            color: #10b981;
        }

        .badge-blocked {
            background: #fff1f2;
            color: #e11d48;
        }

        /* Action Buttons */
        .action-group {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn-offer {
            background: #f5f3ff;
            color: #8b5cf6;
            border: 1px solid #ddd6fe;
        }

        .btn-offer:hover {
            background: #ede9fe;
        }

        .btn-remove-offer {
            background: #fff1f2;
            color: #e11d48;
            border: 1px solid #ffe4e6;
        }

        .btn-remove-offer:hover {
            background: #ffe4e6;
        }

        .btn-block {
            background: #fff7ed;
            color: #c2410c;
            border: 1px solid #ffedd5;
        }

        .btn-block:hover {
            background: #ffedd5;
        }

        .btn-unblock {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #dcfce7;
        }

        .btn-unblock:hover {
            background: #dcfce7;
        }

        .btn-edit {
            background: #eff6ff;
            color: #3b82f6;
            border: 1px solid #dbeafe;
        }

        .btn-edit:hover {
            background: #dbeafe;
        }

        /* Pagination */
        .pagination-wrap {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
        }

        .page-link {
            border: none;
            color: #64748b;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin: 0 2px;
        }

        .page-item.active .page-link {
            background: var(--accent-gold);
            color: white;
        }

        /* Fix Dropdown Clipping */
        .table-responsive {
            overflow: visible !important;
        }

        .product-card {
            overflow: visible !important;
        }

        .dropdown-menu {
            z-index: 1060 !important;
            min-width: 180px;
        }

        /* Clear Search Button */
        .clear-search {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            transition: color 0.2s;
            cursor: pointer;
            padding: 5px;
        }

        .clear-search:hover {
            color: #e11d48;
        }
    </style>

    <div class="content-wrapper">
        <div class="content-header">
            <h2 class="content-title">Product Inventory</h2>
            <div class="search-container">
                <form action="/admin/products" method="get">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search by name or brand..." name="search"
                        value="<%= typeof search !== 'undefined' ? search : '' %>">
                    <% if (typeof search !=='undefined' && search) { %>
                        <a href="/admin/products" class="clear-search" title="Clear Search">
                            <i class="fas fa-times"></i>
                        </a>
                        <% } %>
                </form>
            </div>
        </div>

        <div class="product-card">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Brand</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Offer</th>
                            <th>Stock</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let i=data.length-1; i>=0; i--) { %>
                            <tr>
                                <td class="fw-bold">
                                    <%= data[i].productName %>
                                </td>
                                <td>
                                    <%= data[i].brand && data[i].brand.brandName ? data[i].brand.brandName : 'No Brand'
                                        %>
                                </td>
                                <td><span class="badge bg-light text-dark border">
                                        <%= data[i].category ? data[i].category.name : 'No Category' %>
                                    </span></td>
                                <td>â‚¹<%= data[i].salesPrice.toLocaleString('en-IN') %>
                                </td>
                                <td>
                                    <% if (data[i].productOffer) { %>
                                        <span class="badge bg-primary">
                                            <%= data[i].productOffer %>% Off
                                        </span>
                                        <% } else { %>
                                            <span class="text-muted small">None</span>
                                            <% } %>
                                </td>
                                <td>
                                    <span class="<%= data[i].quantity < 5 ? 'text-danger fw-bold' : '' %>">
                                        <%= data[i].quantity %> units
                                    </span>
                                </td>
                                <td>
                                    <div class="dropdown text-end">
                                        <button class="btn btn-sm btn-light border dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                            <li><a class="dropdown-item py-2"
                                                    href="/admin/editProduct?id=<%=data[i]._id%>">
                                                    <i class="fas fa-edit me-2 text-primary"></i>Edit Inventory</a>
                                            </li>
                                            <% if (data[i].productOffer===0) { %>
                                                <li><button class="dropdown-item py-2"
                                                        onclick="addProductOffer('<%= data[i]._id %>')">
                                                        <i class="fas fa-tag me-2 text-success"></i>Attach
                                                        Offer</button>
                                                </li>
                                                <% } else { %>
                                                    <li><button class="dropdown-item py-2"
                                                            onclick="removeOffer('<%= data[i]._id %>')">
                                                            <i class="fas fa-times me-2 text-danger"></i>Relinquish
                                                            Offer</button>
                                                    </li>
                                                    <% } %>
                                                        <div class="dropdown-divider"></div>
                                                        <li><button
                                                                class="dropdown-item py-2 <%= data[i].isBlocked ? 'text-success' : 'text-danger' %>"
                                                                onclick="toggleProductStatus('<%= data[i]._id %>', <%= data[i].isBlocked %>)">
                                                                <i
                                                                    class="fas <%= data[i].isBlocked ? 'fa-check' : 'fa-ban' %> me-2"></i>
                                                                <%= data[i].isBlocked ? 'Authorize Product'
                                                                    : 'Restrict Product' %>
                                                            </button></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <% if (totalPages> 1) { %>
            <nav class="pagination-wrap">
                <ul class="pagination">
                    <% if (currentPage> 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=1&search=<%= search %>" title="First Page">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>"
                                title="Previous">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        <% } %>

                            <% let startPage=Math.max(1, currentPage - 2); let endPage=Math.min(totalPages, currentPage
                                + 2); if (startPage> 1) { %>
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                <% } %>

                                    <% for (let i=startPage; i <=endPage; i++) { %>
                                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                                                <%= i %>
                                            </a>
                                        </li>
                                        <% } %>

                                            <% if (endPage < totalPages) { %>
                                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                                <% } %>

                                                    <% if (currentPage < totalPages) { %>
                                                        <li class="page-item">
                                                            <a class="page-link"
                                                                href="?page=<%= currentPage + 1 %>&search=<%= search %>"
                                                                title="Next">
                                                                <i class="fas fa-angle-right"></i>
                                                            </a>
                                                        </li>
                                                        <li class="page-item">
                                                            <a class="page-link"
                                                                href="?page=<%= totalPages %>&search=<%= search %>"
                                                                title="Last Page">
                                                                <i class="fas fa-angle-double-right"></i>
                                                            </a>
                                                        </li>
                                                        <% } %>
                </ul>
            </nav>
            <% } %>
    </div>

    <script>
        (function () {
            window.initProducts = function () {
                // Initialize search form
                const searchForm = document.querySelector('.search-container form');
                if (searchForm) {
                    searchForm.onsubmit = function (e) {
                        e.preventDefault();
                        const search = this.querySelector('input[name="search"]').value;
                        const url = `/admin/products?search=${encodeURIComponent(search)}`;
                        if (window.loadContent) {
                            window.loadContent(url);
                        } else {
                            window.location.href = url;
                        }
                    };
                }

                // Initialize pagination links
                document.querySelectorAll('.pagination .page-link').forEach(link => {
                    link.onclick = function (e) {
                        const href = this.getAttribute('href');
                        if (href && href !== '#' && !href.startsWith('javascript:')) {
                            e.preventDefault();
                            const url = `/admin/products${href.startsWith('?') ? href : '?' + href.split('?')[1]}`;
                            if (window.loadContent) {
                                window.loadContent(url);
                            } else {
                                window.location.href = url;
                            }
                        }
                    };
                });

                // Initialize clear search link
                const clearSearch = document.querySelector('.clear-search');
                if (clearSearch) {
                    clearSearch.onclick = function (e) {
                        e.preventDefault();
                        if (window.loadContent) {
                            window.loadContent('/admin/products');
                        } else {
                            window.location.href = '/admin/products';
                        }
                    };
                }
            };

            window.toggleProductStatus = function (id, isBlocked) {
                const action = isBlocked ? 'unblock' : 'block';
                Swal.fire({
                    title: 'Confirm Action',
                    text: `Are you sure you want to ${action} this product?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: isBlocked ? '#10b981' : '#e11d48',
                    confirmButtonText: `Yes, ${action} it`
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`/admin/${action}Product?id=${id}`, {
                                method: 'GET',
                                headers: { 'Accept': 'application/json' }
                            });
                            const data = await response.json();
                            if (data.status || response.ok) {
                                if (window.loadContent) {
                                    window.loadContent(window.location.href);
                                } else {
                                    window.location.reload();
                                }
                            } else {
                                Swal.fire('Error', data.message || 'Operation failed', 'error');
                            }
                        } catch (error) {
                            console.error('Error toggling status:', error);
                            // Fallback if JSON response fails (e.g. redirect)
                            if (window.loadContent) {
                                window.loadContent(window.location.href);
                            } else {
                                window.location.reload();
                            }
                        }
                    }
                });
            };

            window.addProductOffer = async function (productId) {
                const { value: percentage } = await Swal.fire({
                    title: 'Apply Product Offer',
                    input: 'number',
                    inputLabel: 'Percentage Discount',
                    inputPlaceholder: 'Enter a value between 1 and 99',
                    inputAttributes: { min: 1, max: 99, step: 1 },
                    showCancelButton: true
                });

                if (percentage) {
                    try {
                        const response = await fetch('/admin/addProductOffer', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productId, percentage })
                        });
                        const res = await response.json();
                        if (res.status) {
                            Swal.fire('Success', 'Offer applied', 'success').then(() => {
                                if (window.loadContent) {
                                    window.loadContent(window.location.href);
                                } else {
                                    location.reload();
                                }
                            });
                        } else {
                            Swal.fire('Error', res.message || 'Failed to apply offer', 'error');
                        }
                    } catch (error) {
                        Swal.fire('Error', 'Communication failure', 'error');
                    }
                }
            };

            window.removeOffer = function (productId) {
                Swal.fire({
                    title: 'Remove Offer?',
                    text: 'The product will return to its regular price.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#e11d48',
                    confirmButtonText: 'Yes, remove it'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch('/admin/removeProductOffer', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ productId })
                            });
                            const res = await response.json();
                            if (res.status) {
                                Swal.fire('Removed', 'Offer removed successfully', 'success').then(() => {
                                    if (window.loadContent) {
                                        window.loadContent(window.location.href);
                                    } else {
                                        location.reload();
                                    }
                                });
                            } else {
                                Swal.fire('Error', 'Failed to remove offer', 'error');
                            }
                        } catch (error) {
                            Swal.fire('Error', 'Communication failure', 'error');
                        }
                    }
                });
            };

            // Initialize immediately
            window.initProducts();
        })();
    </script>

    <%- include("../../views/partials/admin/footer") %>